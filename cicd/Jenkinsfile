pipeline {
  agent any

  environment {
    TF_DIR          = "terraform"
    VAULT_PASS_FILE = "ansible/vault.pass"
  }

  stages {
    stage('Checkout') { steps { checkout scm } }

    stage('Lint')     { steps { sh 'make lint' } }

    stage('Plan')     { steps { sh 'make plan' } }

    stage('Security Policy') {
      steps { sh "opa eval --format pretty --fail-defined -i ${TF_DIR} -d terraform/opa-policies" }
    }

    stage('Apply') {
      when { branch 'main' }
      steps { sh 'make apply' }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'security/reports/**/*', allowEmptyArchive: true
      cleanWs()
    }
  }
}